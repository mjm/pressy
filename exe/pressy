#!/usr/bin/env ruby
require "pressy"

def main
  store = Pressy::Store::FileStore.new(Dir.pwd)
  site = Pressy::Site.new(store)

  action = ARGV.shift
  raise "no action given" unless action

  case action.to_sym
  when :pull
    result = site.pull
    print_changeset(result.changeset)
  when :push
    result = site.push
    print_changeset(result.changeset)
  else
    raise "unexpected action '#{action}'"
  end
end

def print_changeset(changeset, io = $stderr)
  if changeset.has_changes?
    io.puts "Added #{changeset.added_posts.count} posts." unless changeset.added_posts.empty?
    io.puts "Updated #{changeset.updated_posts.count} posts." unless changeset.updated_posts.empty?
    io.puts "Deleted #{changeset.deleted_posts.count} posts." unless changeset.deleted_posts.empty?
  else
    io.puts "Already up-to-date."
  end
end

main
